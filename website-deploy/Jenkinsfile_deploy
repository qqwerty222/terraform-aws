pipeline {

    agent {label 'terraform'}
    // triggers { pollSCM('* * * * *') }
    environment {
        TF_VAR_PROJECT_NAME="website-deploy"
        
        TF_VAR_AWS_ACCESS_KEY=credentials('aws_access_key')
        TF_VAR_AWS_SECRET_KEY=credentials('aws_secret_key')
        TF_VAR_AWS_AVAILABILITY_ZONE="eu-central-1b"
        TF_VAR_AWS_REGION="eu-central-1"
        
        TF_VAR_CONSUL_DC="dc1"
        TF_VAR_CONSUL_IP="10.0.2.15:8500"
        TF_VAR_CONSUL_TOKEN=credentials('consul_token')
        
        TF_VAR_PROXY_PUBLIC_KEY=credentials('ssh_proxy_pub')
        TF_VAR_WEBSITE_PUBLIC_KEY=credentials('ssh_website_pub')
        
        TF_VAR_DD_API_KEY=credentials('datadog_api_key')
        TF_VAR_DD_APP_KEY=credentials('datadog_app_key')
    }
    
    stages { 
        stage('Prepare Terraform Codebase'){
            steps{
                cleanWs()
                checkout scm: [$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: 
                [[credentialsId: 'ssh-github', url: 'git@github.com:qqwerty222/terraform-aws.git' ]]]
            }
        }
        stage('Deploy network'){
            steps {
                dir('website-deploy/network') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }
        stage('Deploy sec groups'){
            steps {
                dir('website-deploy/security_groups') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }
        stage('Deploy ssh_keys'){
            steps {
                dir('website-deploy/ssh_keys') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }
        stage('Deploy ec2'){
            steps {
                dir('website-deploy/ec2') {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }
    }
}
